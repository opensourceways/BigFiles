FROM golang:1.21 as BUILDER

WORKDIR /home
COPY . .
RUN go get github.com/akrylysov/algnhsa && \
    go get github.com/sirupsen/logrus && \
    go build ./main.go

FROM openeuler/openeuler:22.03
LABEL maintainer="Zhou Yi 1123678689@qq.com"
RUN useradd -s /bin/bash BigFiles
USER root
#配置ssh服务
RUN dnf -y update && \
    dnf -y install openssh && \
    dnf -y install openssh-server && \
    dnf -y install openssh-clients && \
    dnf -y install sshpass
RUN echo 'BigFiles:123456' | chpasswd
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

WORKDIR /etc/ssh
#生成ssh服务本地秘钥
RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N ""
RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_ecdsa_key -N ""
RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_ed25519_key -N ""

#复制ssh服务启动与端口转发脚本
COPY --chown=BigFiles:group --from=BUILDER /home/scripts/ssh /
RUN chmod +x /port_forward.sh
RUN chmod +x /start.sh
RUN chmod +x /begin.sh
# RUN chmod 305 /etc/ssh/sshd_config
RUN chmod 777 /etc/ssh/sshd_config
RUN chmod 777 /usr/sbin/sshd
RUN chmod 305 /etc/ssh/ssh_host_rsa_key

WORKDIR /home/BigFiles
USER BigFiles
COPY --chown=BigFiles:group --from=BUILDER /home/main /home/BigFiles/main

EXPOSE 23231
EXPOSE 5000

ENTRYPOINT ["/begin.sh"]
